<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Best Combination Finder</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f8fafc; color:#111; margin:0; }
    .container { max-width:1100px; margin:auto; padding:24px; }
    h1 { margin-bottom:4px; }
    .note { color:#555; font-size:14px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:12px; padding:16px; margin-top:12px; }
    input:not([type="checkbox"]), button, select { width:100%; box-sizing:border-box; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    button { background:#2563eb; color:white; font-weight:600; border:none; cursor:pointer; margin-top:12px; }
    button.secondary { background:#111; }
    .grid { display:grid; gap:16px; }
    @media (min-width:768px){ .grid-2{ grid-template-columns:1fr 1fr; } .grid-3{ grid-template-columns:1fr 1fr 1fr; } }
    .stat { border:1px solid #ddd; border-radius:8px; padding:10px; background:#f9fafb; }
    .stat .label{color:#555;font-size:12px;}
    .stat .value{font-size:18px;font-weight:700;}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top;}
    .warn{background:#fffbeb;border:1px solid #fef3c7;padding:8px;border-radius:8px;margin-top:6px;}
    .err{background:#fef2f2;border:1px solid #fee2e2;padding:8px;border-radius:8px;margin-top:6px;}
    .ok{background:#ecfdf5;border:1px solid #d1fae5;padding:8px;border-radius:8px;margin-top:6px;}
    .checklist { display:flex; flex-wrap:wrap; gap:10px; }
    label.machine, label.category { display:inline-flex; align-items:center; gap:8px; border:1px solid #ccc; border-radius:8px; padding:6px 10px; background:#fff; cursor:pointer; min-width:160px; user-select:none; }
    label.machine.dim, label.category.dim { opacity:0.6; }
    label.machine input[type="checkbox"], label.category input[type="checkbox"] { width:18px; height:18px; flex-shrink:0; }
    label.machine span, label.category span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    details summary { cursor:pointer; }
    .topbar { text-align:right;font-size:13px;color:#555;margin-bottom:4px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">Created by Tony Lu (2025)</div>
    <div class="row" style="justify-content:space-between;align-items:baseline;">
      <div>
        <h1>點點心大師</h1>
      </div>
      <a href="https://pay.yallvend.com/app/point_check/point_check?key=35269efad18c5c3c8021107649e65eb73756d5920dcc7a7e4ab724fec6b4743f&country=tw
" target="_blank" style="text-decoration:underline;">Check balance ↗</a>
      <div class="note">Balance checking UserName: W + ID</div>
    </div>

    <div class="grid grid-2 card">
      <div>
        <label>Total Budget</label>
        <input id="budget" type="number" step="1" value="50" />
      </div>
      <div>
        <label>Allowed Remaining Money</label>
        <input id="allowLeft" type="number" step="1" value="0" />
      </div>
    </div>

    <div class="card">
      <label>Select Vending Machines</label>
      <div id="machineList" class="checklist"></div>
    </div>

    <div class="card">
      <label>Select Categories</label>
      <div id="categoryList" class="checklist"></div>
    </div>

    <div class="card">
      <button id="run">Calculate Best Combination</button>
      <button id="reset" class="secondary">Clear Result</button>
      <div id="messages"></div>
    </div>

    <div class="grid grid-3 card">
      <div class="stat"><div class="label">Best Total</div><div class="value" id="statBest">—</div></div>
      <div class="stat"><div class="label">Remaining</div><div class="value" id="statRemain">—</div></div>
      <div class="stat"><div class="label">Combinations</div><div class="value" id="statCount">—</div></div>
    </div>

    <div class="card">
      <h3>Best Solutions</h3>
      <div id="excludeBar" class="row" style="margin-bottom:8px;">
        <div class="note" id="excludeCount">Excluded unit prices: 0</div>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button id="recalcExcluded">Recalculate without checked prices</button>
          <button id="clearExcluded" class="secondary">Clear price exclusions</button>
        </div>
      </div>
      <div id="list"></div>
    </div>

    <div class="card">
      <h3>Report anomaly / suggestion</h3>
      <div class="note">Use this link to submit updates or feedback (e.g., item disappeared, wrong price, new item, suggestions).</div>
      <a id="reportLink" href="https://docs.google.com/forms/d/e/1FAIpQLSf1AJok723JrwLvD0LFKKWBkxCgJX4xoHJpcRhkRWByDGqFhA/viewform?usp=header" target="_blank" style="text-decoration:underline;">Open report form ↗</a>
    </div>
  </div>

<script>
(function(){
  // ==== Config & Data ====
  const EXCLUDED_MACHINES_BY_DEFAULT = new Set(['5F教學部側(無打折)']);
  const CATEGORIES = ['Drink','Snack','Other'];
  const EXCLUDED_CATS_BY_DEFAULT = new Set([]);
  const items = [
    { name: "海苔杏仁小魚", priceCents: 3500, loc: "5F教學部側(無打折)", cat: 'Other' },
    { name: "威德in果凍飲", priceCents: 4200, loc: "5F教學部側(無打折)", cat: 'Drink' },
    { name: "微笑河馬巧克力餅", priceCents: 3500, loc: "5F教學部側(無打折)", cat: 'Snack' },
    { name: "卡迪那原味薯條", priceCents: 4500, loc: "5F教學部側(無打折)", cat: 'Snack' },
    { name: "沙茶豆干", priceCents: 3500, loc: "5F教學部側(無打折)", cat: 'Other' },
    { name: "張君雅系列", priceCents: 2500, loc: "5F教學部側(無打折)", cat: 'Snack' },
    { name: "貝果", priceCents: 2800, loc: "5F教學部側(無打折)", cat: 'Other' },
    { name: "草莓夾心麵包", priceCents: 2500, loc: "5F教學部側(無打折)", cat: 'Other' },
    { name: "樂事海苔洋芋片", priceCents: 2500, loc: "5F教學部側(無打折)", cat: 'Snack' },
    { name: "義美小泡芙", priceCents: 3000, loc: "5F教學部側(無打折)", cat: 'Snack' },
    { name: "波的多蚵仔煎", priceCents: 2000, loc: "5F教學部側(無打折)", cat: 'Snack' },
    { name: "可樂果", priceCents: 2000, loc: "5F教學部側(無打折)", cat: 'Snack' },
    { name: "麥香/波蜜果茶", priceCents: 1500, loc: "5F教學部側(無打折)", cat: 'Drink' },
    { name: "BOGAR氣泡水", priceCents: 2500, loc: "5F教學部側(無打折)", cat: 'Drink' },
    { name: "麥茶", priceCents: 2500, loc: "5F教學部側(無打折)", cat: 'Drink' },
    { name: "茶裏王", priceCents: 2000, loc: "5F教學部側(無打折)", cat: 'Drink' },
    { name: "比較貴的茶裏王", priceCents: 2400, loc: "5F教學部側(無打折)", cat: 'Drink' },
    { name: "百事可樂", priceCents: 3000, loc: "5F教學部側(無打折)", cat: 'Drink' },
    { name: "海苔杏仁小魚", priceCents: 3200, loc: "5F刀房側A", cat: 'Other' },
    { name: "綜合堅果", priceCents: 3200, loc: "5F刀房側A", cat: 'Other' },
    { name: "科學麵", priceCents: 1000, loc: "5F刀房側A", cat: 'Snack' },
    { name: "百慕達脆薯", priceCents: 1800, loc: "5F刀房側A", cat: 'Snack' },
    { name: "義美小泡芙", priceCents: 2700, loc: "5F刀房側A", cat: 'Snack' },
    { name: "旺旺", priceCents: 2700, loc: "5F刀房側A", cat: 'Snack' },
    { name: "ChocoPie", priceCents: 2300, loc: "5F刀房側A", cat: 'Snack' },
    { name: "卡迪娜番茄薯條", priceCents: 2300, loc: "5F刀房側A", cat: 'Snack' },
    { name: "品客", priceCents: 2700, loc: "5F刀房側A", cat: 'Snack' },
    { name: "奶酥麵包/巧克力麵包", priceCents: 2300, loc: "5F刀房側A", cat: 'Other' },
    { name: "草莓/花生三明治", priceCents: 2700, loc: "5F刀房側A", cat: 'Other' },
    { name: "RedBull", priceCents: 5400, loc: "5F刀房側A", cat: 'Drink' },
    { name: "統一布丁", priceCents: 1800, loc: "5F刀房側A", cat: 'Other' },
    { name: "伴點巧克力牛奶", priceCents: 1800, loc: "5F刀房側A", cat: 'Drink' },
    { name: "微蘇打", priceCents: 1800, loc: "5F刀房側A", cat: 'Drink' },
    { name: "芬達", priceCents: 2300, loc: "5F刀房側A", cat: 'Drink' },
    { name: "舒跑", priceCents: 1800, loc: "5F刀房側A", cat: 'Drink' },
    { name: "可口可樂", priceCents: 2300, loc: "5F刀房側A", cat: 'Drink' },
    { name: "偉恩咖啡", priceCents: 2700, loc: "5F刀房側A", cat: 'Drink' },
    { name: "康貝特咖啡", priceCents: 3000, loc: "5F刀房側A", cat: 'Drink' },
    { name: "阿華田", priceCents: 2700, loc: "5F刀房側A", cat: 'Drink' },
    { name: "八寶粥", priceCents: 3600, loc: "5F刀房側A", cat: 'Other' },
    { name: "TreeTop蘋果汁", priceCents: 2700, loc: "5F刀房側A", cat: 'Drink' },
    { name: "微舒打", priceCents: 1800, loc: "5F刀房側A", cat: 'Drink' },
    { name: "PH9.0純水", priceCents: 2300, loc: "5F刀房側A", cat: 'Drink' },
    { name: "茶裏王", priceCents: 1800, loc: "5F刀房側A", cat: 'Drink' },
    { name: "鱈魚香絲", priceCents: 2300, loc: "5F刀房側A", cat: 'Snack' },
    { name: "飲冰室茶集", priceCents: 2300, loc: "5F刀房側B", cat: 'Drink' },
    { name: "可爾必思", priceCents: 2300, loc: "5F刀房側B", cat: 'Drink' },
    { name: "瑞穗巧克力牛奶", priceCents: 3000, loc: "5F刀房側B", cat: 'Drink' },
    { name: "瑞穗鮮奶", priceCents: 3200, loc: "5F刀房側B", cat: 'Drink' },
    { name: "TreeTop蘋果汁", priceCents: 2700, loc: "5F刀房側B", cat: 'Drink' },
    { name: "AB優酪乳", priceCents: 2500, loc: "5F刀房側B", cat: 'Drink' },
    { name: "木瓜牛乳", priceCents: 3200, loc: "5F刀房側B", cat: 'Drink' },
    { name: "糙米漿", priceCents: 2300, loc: "5F刀房側B", cat: 'Drink' },
    { name: "純喫茶", priceCents: 1800, loc: "5F刀房側B", cat: 'Drink' },
    { name: "農榨", priceCents: 2700, loc: "5F刀房側B", cat: 'Drink' },
    { name: "統一無糖豆漿", priceCents: 2300, loc: "5F刀房側B", cat: 'Drink' },
    { name: "TreeTop蘋果汁", priceCents: 2700, loc: "5F刀房側B", cat: 'Drink' },
    { name: "綜合堅果", priceCents: 3200, loc: "1F宿舍A", cat: 'Other' },
    { name: "科學麵", priceCents: 1000, loc: "1F宿舍A", cat: 'Snack' },
    { name: "微笑河馬巧克力餅", priceCents: 3200, loc: "1F宿舍A", cat: 'Snack' },
    { name: "沙茶豆干", priceCents: 3200, loc: "1F宿舍A", cat: 'Other' },
    { name: "可樂果", priceCents: 1800, loc: "1F宿舍A", cat: 'Snack' },
    { name: "卡迪娜番茄薯條", priceCents: 2300, loc: "1F宿舍A", cat: 'Snack' },
    { name: "旺旺", priceCents: 2700, loc: "1F宿舍A", cat: 'Snack' },
    { name: "波的多蚵仔煎", priceCents: 1800, loc: "1F宿舍A", cat: 'Snack' },
    { name: "統一泡麵", priceCents: 2100, loc: "1F宿舍A", cat: 'Other' },
    { name: "來一客", priceCents: 2300, loc: "1F宿舍A", cat: 'Other' },
    { name: "拉麵道", priceCents: 3200, loc: "1F宿舍A", cat: 'Other' },
    { name: "MountainDew", priceCents: 2300, loc: "1F宿舍A", cat: 'Drink' },
    { name: "品客", priceCents: 2700, loc: "1F宿舍A", cat: 'Snack' },
    { name: "伴點巧克力牛奶", priceCents: 1800, loc: "1F宿舍A", cat: 'Drink' },
    { name: "咖啡廣場", priceCents: 1500, loc: "1F宿舍A", cat: 'Drink' },
    { name: "TreeTop蘋果汁", priceCents: 2700, loc: "1F宿舍A", cat: 'Drink' },
    { name: "舒跑", priceCents: 1800, loc: "1F宿舍A", cat: 'Drink' },
    { name: "阿華田", priceCents: 2700, loc: "1F宿舍A", cat: 'Drink' },
    { name: "微蘇打", priceCents: 1800, loc: "1F宿舍A", cat: 'Drink' },
    { name: "寶礦力水得", priceCents: 1800, loc: "1F宿舍A", cat: 'Drink' },
    { name: "八寶粥", priceCents: 3600, loc: "1F宿舍A", cat: 'Other' },
    { name: "TreeTop蘋果汁", priceCents: 2700, loc: "1F宿舍A", cat: 'Drink' },
    { name: "茶裏王", priceCents: 1800, loc: "1F宿舍A", cat: 'Drink' },
    { name: "比較貴的茶裏王", priceCents: 2300, loc: "1F宿舍A", cat: 'Drink' },
    { name: "青草茶", priceCents: 2300, loc: "1F宿舍A", cat: 'Drink' },
    { name: "麥香寶特瓶", priceCents: 2300, loc: "1F宿舍A", cat: 'Drink' },
    { name: "飲冰室茶集", priceCents: 2300, loc: "1F宿舍B", cat: 'Drink' },
    { name: "可爾必思", priceCents: 2300, loc: "1F宿舍B", cat: 'Drink' },
    { name: "偉恩咖啡", priceCents: 2700, loc: "1F宿舍B", cat: 'Drink' },
    { name: "瑞穗巧克力牛奶", priceCents: 3000, loc: "1F宿舍B", cat: 'Drink' },
    { name: "瑞穗鮮奶", priceCents: 3200, loc: "1F宿舍B", cat: 'Drink' },
    { name: "AB優酪乳", priceCents: 2500, loc: "1F宿舍B", cat: 'Drink' },
    { name: "木瓜牛乳", priceCents: 3200, loc: "1F宿舍B", cat: 'Drink' },
    { name: "糙米漿", priceCents: 2300, loc: "1F宿舍B", cat: 'Drink' },
    { name: "無糖豆漿", priceCents: 2300, loc: "1F宿舍B", cat: 'Drink' },
    { name: "純喫茶", priceCents: 1800, loc: "1F宿舍B", cat: 'Drink' },
    { name: "農榨", priceCents: 2700, loc: "1F宿舍B", cat: 'Drink' }
  ];


  // ==== Utils ====
  const money = (c)=> Math.round(c/100);
  const byId = (id)=> document.getElementById(id);
  const errBox = (msg)=>{ const d=document.createElement('div'); d.className='err'; d.textContent='❌ '+msg; return d; };
  const warnBox = (msg)=>{ const d=document.createElement('div'); d.className='warn'; d.textContent='⚠️ '+msg; return d; };
  const escapeHtml = (s)=> String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;');

  // Build a catalog by unit price: priceCents -> { name -> Set(locations) }
  function buildPriceCatalog(list){
    const byPrice = new Map();
    for(const it of list){
      if(!byPrice.has(it.priceCents)) byPrice.set(it.priceCents, new Map());
      const byName = byPrice.get(it.priceCents);
      if(!byName.has(it.name)) byName.set(it.name, new Set());
      byName.get(it.name).add(it.loc);
    }
    return byPrice;
  }

  // Enumerate ALL exact-sum combinations by UNIT PRICES (unbounded, with pruning)
  // returns array of { total, counts: Map<price, qty> }
  function enumerateCombos(pricesDesc, target, cap){
    const out = [];
    const cur = new Map();

    function dfs(idx, remaining){
      if(out.length >= cap) return; // cap to avoid explosion
      if(idx === pricesDesc.length - 1){
        const p = pricesDesc[idx];
        if(remaining % p === 0){
          const q = Math.floor(remaining / p);
          if(q >= 0){ cur.set(p, (cur.get(p)||0) + q); pushCur(); cur.set(p, (cur.get(p)||0) - q); if(cur.get(p)===0) cur.delete(p); }
        }
        return;
      }
      const p = pricesDesc[idx];
      const maxQ = Math.floor(remaining / p);
      for(let q = maxQ; q >= 0; q--){
        if(q>0){ cur.set(p, (cur.get(p)||0) + q); }
        const rem = remaining - q*p;
        if(rem < 0) { if(q>0){ cur.set(p, cur.get(p)-q); if(cur.get(p)===0) cur.delete(p);} break; }
        dfs(idx+1, rem);
        if(q>0){ cur.set(p, cur.get(p)-q); if(cur.get(p)===0) cur.delete(p); }
        if(out.length >= cap) return;
      }
    }

    function pushCur(){
      const counts = new Map();
      for(const [k,v] of cur.entries()){ if(v>0) counts.set(k,v); }
      out.push({ total: target, counts });
    }

    dfs(0, target);
    return out;
  }

  // ==== DOM refs ====
  const machineList = byId('machineList');
  const categoryList = byId('categoryList');
  const budgetInput = byId('budget');
  const allowInput = byId('allowLeft');
  const messages = byId('messages');
  const list = byId('list');
  const statBest = byId('statBest');
  const statRemain = byId('statRemain');
  const statCount = byId('statCount');
  const excludeCountEl = byId('excludeCount');
  const btnRun = byId('run');
  const btnReset = byId('reset');
  const btnRecalc = byId('recalcExcluded');
  const btnClearEx = byId('clearExcluded');

  // Exclusions by unit price
  const excludedPrices = new Set();
  const updateExcludeCount = ()=>{ if(excludeCountEl) excludeCountEl.textContent = 'Excluded unit prices: ' + excludedPrices.size; };

  function initMachineList(){
    const locs = [...new Set(items.map(x=>x.loc))].sort();
    machineList.innerHTML = '';
    locs.forEach(loc=>{
      const label = document.createElement('label'); label.className='machine';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value=loc; cb.checked=!EXCLUDED_MACHINES_BY_DEFAULT.has(loc);
      const span = document.createElement('span'); span.textContent = loc;
      label.appendChild(cb); label.appendChild(span);
      machineList.appendChild(label);
    });
  }

  function initCategoryList(){
    categoryList.innerHTML = '';
    CATEGORIES.forEach(cat=>{
      const label=document.createElement('label'); label.className='category';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.value=cat; cb.checked=!EXCLUDED_CATS_BY_DEFAULT.has(cat);
      const span=document.createElement('span'); span.textContent=cat;
      label.appendChild(cb); label.appendChild(span);
      categoryList.appendChild(label);
    });
  }

  function getChecked(listEl){
    return Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked')).map(x=>x.value);
  }

  function renderCombos(allCombos, budgetCents, priceCatalog){
    list.innerHTML = '';
    const frag = document.createDocumentFragment();

    allCombos.forEach((combo, idx)=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<h4>Combination #${idx+1}</h4><div>Total: ${money(combo.total)} | Remaining: ${money(budgetCents-combo.total)}</div>`;

      // rows by unit price desc
      const prices = [...combo.counts.keys()].sort((a,b)=>b-a);
      const rows = prices.map(p=>{
        const qty = combo.counts.get(p);
        const subtotal = p*qty;
        const checked = excludedPrices.has(p) ? 'checked' : '';
        const byName = priceCatalog.get(p) || new Map();
        const optionsHtml = [...byName.entries()].map(([name, locSet])=>{
          const locs = [...locSet].join(', ');
          return `<li>${escapeHtml(name)} <span class="note">(${escapeHtml(locs)})</span></li>`;
        }).join('');
        const details = `<details><summary>Show items for price ${money(p)}</summary><ul style="margin:4px 0 0 20px;">${optionsHtml || '<li class="note">No items listed</li>'}</ul></details>`;
        return `<tr><td colspan="4"><label><input type="checkbox" class="exclude-price" data-price="${p}" ${checked} /></label><div>${details}</div></td><td>${money(p)} × ${qty} = ${money(subtotal)}</td></tr>`;
      }).join('');

      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr><th colspan="4">Exclude & Items</th><th>Total</th></tr></thead><tbody>${rows}</tbody>`;

      card.appendChild(tbl); frag.appendChild(card);
    });

    list.appendChild(frag);

    document.querySelectorAll('input.exclude-price').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const p = Number(cb.getAttribute('data-price'));
        if(cb.checked) excludedPrices.add(p); else excludedPrices.delete(p);
        updateExcludeCount();
      });
    });
    updateExcludeCount();
  }

  function runCalc(){
    try{
      messages.innerHTML=''; list.innerHTML='';
      const budgetVal = Number(budgetInput.value)||0;
      const allowVal = Number(allowInput.value)||0;
      if(budgetVal<=0 || budgetVal>200){ messages.appendChild(errBox('Budget must be between 0 and 200.')); return; }
      const budgetCents = Math.round(budgetVal*100);
      const allowCents = Math.round(allowVal*100);

      const selectedMachines = getChecked(machineList);
      const selectedCats = getChecked(categoryList);
      if(selectedMachines.length===0){ messages.appendChild(errBox('Please select at least one machine.')); return; }
      if(selectedCats.length===0){ messages.appendChild(errBox('Please select at least one category.')); return; }

      // Filter items by machine/cat and price exclusions
      const filtered = items.filter(x=> selectedMachines.includes(x.loc) && selectedCats.includes(x.cat) && !excludedPrices.has(x.priceCents));
      if(filtered.length===0){ messages.appendChild(errBox('No items match filters / exclusions.')); return; }

      // Build catalog and PRICES list (unique unit prices)
      const priceCatalog = buildPriceCatalog(filtered);
      const pricesDesc = [...new Set(filtered.map(x=>x.priceCents))].sort((a,b)=>b-a);
      if(pricesDesc.length===0){ messages.appendChild(errBox('No valid prices after filtering.')); return; }

      // Enumerate ALL combos for each target sum from budget -> (budget-allow)
      const low = Math.max(0, budgetCents - allowCents);
      const capPerTarget = 2000; // safety cap per target sum
      const allCombos = [];
      for(let target = budgetCents; target >= low; target--){
        const combos = enumerateCombos(pricesDesc, target, capPerTarget);
        // append
        for(const c of combos){ allCombos.push(c); }
        if(combos.length >= capPerTarget){ messages.appendChild(warnBox(`Reached combo cap (${capPerTarget}) at total ${money(target)}. Showing partial results for this total.`)); }
      }

      if(allCombos.length===0){ messages.appendChild(errBox('No combination found.')); return; }

      // Stats based on the BEST total (first combo's total)
      statBest.textContent = money(allCombos[0].total);
      statRemain.textContent = money(budgetCents - allCombos[0].total);
      statCount.textContent = allCombos.length;

      renderCombos(allCombos, budgetCents, priceCatalog);
    }catch(e){
      console.error(e);
      messages.appendChild(errBox('Unexpected error: '+ (e && e.message ? e.message : e)));
    }
  }

  function resetAll(){
    list.innerHTML=''; messages.innerHTML='';
    excludedPrices.clear(); updateExcludeCount();
    statBest.textContent='—'; statRemain.textContent='—'; statCount.textContent='—';
  }

  // ==== Wire up ====
  window.addEventListener('DOMContentLoaded', ()=>{
    try{ initMachineList(); }catch(e){ console.error(e); }
    try{ initCategoryList(); }catch(e){ console.error(e); }
    updateExcludeCount();
    const runBtn = byId('run'); if(runBtn) runBtn.addEventListener('click', runCalc);
    const resetBtn = byId('reset'); if(resetBtn) resetBtn.addEventListener('click', resetAll);
    const recalcBtn = byId('recalcExcluded'); if(recalcBtn) recalcBtn.addEventListener('click', runCalc);
    const clearBtn = byId('clearExcluded'); if(clearBtn) clearBtn.addEventListener('click', ()=>{ excludedPrices.clear(); updateExcludeCount(); runCalc(); });
  });
})();
</script>
</body>
</html>
